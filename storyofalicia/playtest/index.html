<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="assets/common.css">
    <title>Story of Alicia playtest</title>

    <script src="https://kit.fontawesome.com/0ead5b1f35.js" crossorigin="anonymous"></script>
</head>
<script>

//! Latest game version identifier.
const LatestGameVersion = "03/01/2026";

//! A flag indicating whether an update is required.
let isUpdateRequired = false;
//! A flag indicating whether credentials are supplied.
let areCredentialsSupplied = false;
//! A flag indicating whether rules are acknowledged.
let areRulesAcknowledged = false;
//! A flag indicating whether issues are acknowledged.
let areIssuesAcknowledged = false;

let userName = null;
let userToken = null;

function setup()
{
  areRulesAcknowledged = iunderstandrules.checked;
  areIssuesAcknowledged = iunderstandissues.checked;

  scrapeCredentials();

  performCredentialsCheck();
  performVersionCheck();
  validateLaunchConditions();
  validatePlayConditions();

  iunderstandissues.onchange = function() {
    areIssuesAcknowledged = this.checked;
    validatePlayConditions();
  };
  iunderstandrules.onchange = function() {
    areRulesAcknowledged = this.checked;
    validatePlayConditions();
  };
}

function validateLaunchConditions()
{
  if (areCredentialsSupplied && isUpdateRequired === false)
  {
    launch.classList.remove("invisible");
  }
  else
  {
    launch.classList.add("invisible");
  }
}

function validatePlayConditions()
{
  if (areCredentialsSupplied 
    && isUpdateRequired === false
    && areIssuesAcknowledged 
    && areRulesAcknowledged 
    && !isUpdateRequired)
  {
    enableEnterVisually();
  }
  else
  {
    disableEnterVisually();
  }
}

function enableEnterVisually()
{
  enterButton.classList.remove("button-primary-inactive");
}

function disableEnterVisually()
{
  enterButton.classList.add("button-primary-inactive");
}

function enableSigninVisually()
{
  requireCredentials.classList.remove("invisible");
}

function disableSigninVisually()
{
  requireCredentials.classList.add("invisible");
}

function enableRequireUpdateVisually()
{
  version.textContent = 'A new and required version of the launcher is available for download.';
  requireDownload.classList.remove("invisible");

  downloadButton.classList.remove("button-secondary");
  downloadButton.classList.add("button-primary");
}

function disableRequireUpdateVisually()
{
  version.textContent = 'You seem to have the latest version of the launcher. You do not need to download the launcher again.';
  requireDownload.classList.add("invisible");

  downloadButton.classList.remove("button-primary");
  downloadButton.classList.add("button-secondary");
}

//! Retrieves and scrapes credentials from the URL parameters and stores them in the local storage.
function scrapeCredentials()
{
  const params = new URLSearchParams(document.location.search);
  const hasCredentials = params.has("user") && params.has("token");

  if (!hasCredentials)
      return;

  userName = params.get("user");
  userToken = params.get("token");

  const url = new URL(document.location);
  url.search = "";
  window.history.replaceState({}, document.title, url.toString());

  console.log("Credentials retrieved and scrapped from the URL.");
}

//! 
function performCredentialsCheck()
{
  const hasCredentials = userName !== null && userToken !== null;

  if (hasCredentials)
  {
    areCredentialsSupplied = true;

    disableSigninVisually();

    console.log("Credentials are supplied.");
  }
  else
  {
    areCredentialsSupplied = false;

    enableSigninVisually();

    console.log("Credentials are not supplied.");
  }
}

function performVersionCheck()
{
  // Fetch the game version stored in local storage.
  const gameVersion = localStorage.getItem("soa-game-version");

  console.log(`Current reported version: ${gameVersion}, latest version: ${LatestGameVersion}`);

  if (LatestGameVersion !== gameVersion)
  {
    isUpdateRequired = true;
    enableRequireUpdateVisually();

    console.log('Update of the launcher is required.');
  }
  else
  {
    isUpdateRequired = false;
    disableRequireUpdateVisually()

    console.log('Update of the launcher is not required.');
  }
}

function handleDownload()
{
  version.textContent = 'A download of the new launcher has started, make sure to install it.';

  setTimeout(() => {
    isUpdateRequired = false;
    validateLaunchConditions();
    disableRequireUpdateVisually();
    validatePlayConditions();
    localStorage.setItem("soa-game-version", LatestGameVersion);
  }, 5000);
}

function handleEnter()
{
  if (isUpdateRequired)
  {
    alert("Please download and install the latest version of the launcher before entering the playtest.");
    return;
  }

  const timeout = 15000;
  const uri = `soa://4/?username=${encodeURIComponent(userName)}&token=${encodeURIComponent(userToken)}`;
  window.location.href = uri;

  setTimeout(() => {
      alert("If the game did not launch, please ensure it is properly installed.\n\nIf the game opened up and immediately closed, report the issue on our Discord server.");
  }, timeout);
}

window.onload = setup;

</script>
<body class="fade-in">
  <div class="main">
    <div class="container">
      <h2>THE PLAYTEST</h2>
    </div>
    <div class="container">
      <h4>Download the launcher</h4>
      <p id="version">Before playing you must download and install the latest version of the game launcher.</p>
      <a 
        onclick="handleDownload()" 
        id="downloadButton" 
        class="button button-primary" 
        href="https://drive.proton.me/urls/37WM215Q1R#NlzxAZSg7VFC" 
        target="_blank">
      Download the launcher
      </a>
      <p>
        If the download link doesn't work for you, you can use this <br>
        <a 
          onclick="handleDownload()" 
          href="https://drive.google.com/file/d/1NMh_Y8UsTB4HgfR5qVP81ko-ukKSA_00/view" 
          target="_blank">
           <i class="fa-solid fa-up-right-from-square"></i>Google mirror</a>.
      </p>
    </div>
    <div class="container">
      <h4>Launch the game</h4>
      <div id="launch" class="container invisible">
        <p>Once the launcher is installed, click the ENTER below to enter the playtest.</p>

        <div class="checkbox">
          <input id="iunderstandissues" type="checkbox"></input>
          <span>I understand the game has a lot of bugs and it is not the final version.</span>
        </div>

        <div class="checkbox">
          <input id="iunderstandrules" type="checkbox"></input>
          <span>I have read and clearly understand <a href="https://docs.google.com/document/d/1ywa6xnbH2WDev4K81vOlWsSO-dLJ1nrLpUl4mPXBGpQ" target="_blank">
             <i class="fa-solid fa-up-right-from-square"></i>the server rules</a> which I'll obey by.</span>
        </div>
        <a onclick="handleEnter()" id="enterButton" class="button button-primary">enter the game*</a>
      </div>
      <div id="requireDownload" class="container invisible">
        To enter the public play test you must download and install the latest version of the launcher above.
      </div>
      <div id="requireCredentials" class="container invisible">
        To enter the public play test you must sign in with your discord.
        <a 
          class="button button-primary"  
          href="https://discord.com/oauth2/authorize?client_id=1272602862043795586&response_type=code&redirect_uri=https%3A%2F%2Fauthentication.storyofalicia.com%2F&scope=identify">
          <img class="icon" src="assets/discord.svg" width="20px" alt="">
          proceed with discord*
        </a>
        <p>*By clicking the "Proceed with Discord" button, you acknowledge that your Discord ID will be stored on our database servers indefinitely for identification and service purposes. This data can be removed upon request by emailing dev@storyofalicia.com.</p>
      </div>
    </div>
  </div>
  <div class="footer">
    <a href="https://storyofalicia.com" target="_blank">About us</a>
    <a href="https://discord.gg/storyofalicia" target="_blank">Join official Discord server</a>
    <a href="https://github.com/story-of-alicia" target="_blank">See our Github</a>
    <a href="https://wiki.storyofalicia.com" target="_blank">Read our Wiki</a>
    <a href="https://samko.cc/alicia" target="_blank">Samuel's catalogue and generator</a>
  </div>
</body>
</html>
